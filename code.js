let areaCoords=[{top:45.657,right:6.938,bottom:45.491,left:6.7397},{top:45.728,right:7.104,bottom:45.397,left:6.724}];var canvas=document.getElementById("map");canvas.addEventListener("click",showDetails);var g=canvas.getContext("2d");const area1image=new Image;area1image.src="https://github.com/Denis-Adv/automatic-space-memory/blob/codespace-denis-adv-automatic-space-memory-9rwx4g99w99hxpxx/carte1.jpg?raw=true";const area2image=new Image;area2image.src="https://github.com/Denis-Adv/automatic-space-memory/blob/codespace-denis-adv-automatic-space-memory-9rwx4g99w99hxpxx/carte2.jpg?raw=true";let hotRects,areaimages=[area1image,area2image],currentAreaIdx=0,currentParamName="temperature",reports=JSON.parse('[ {"station": {"name": "BOURG ST MAURICE","uuid": "babe0746-591f-4514-913c-e0943d45f62f","latitude": 45.6127,"longitude": 6.76333,"elevation": 865,"city": "Bourg-Saint-Maurice (73)"},"observation": {"time": "2023-02-16T17:00:00+00:00","temperature": {"value": "8.7","name": "temperature","longname": "Temperature de l air","unit": "°C","resolution": 0.1},"humidity": {"value": "43","name": "humidity","longname": "Humidité relative","unit": "%","resolution": 1}}}]'),time=(new Date).getTime()-6e4;time-=time%36e5;let dataDate=new Date(time);function downloadReports(){const e=document.getElementById("error");download(dataDate,function(){4==this.readyState&&200==this.status?(reports=JSON.parse(this.responseText),e.hidden=!0,selectArea(0)):(reports=[],0!==this.status&&(e.innerHTML="Error: "+this.status,e.hidden=!1))})}function download(e,t){let a="https://api.meteo-concept.com/api/observations/around?datetime="+e.toISOString().replace(":00.000Z","%2B00%3A00").replace(":","%3A")+"&latlng=45.6,6.8&radius=30&token=3e8594fdf44b63465e0452d1f4bada50647f8534eed6c10029886d6361d3d153";var r=new XMLHttpRequest;r.onreadystatechange=t,r.open("GET",a,!0),r.setRequestHeader("Access-Control-Allow-Headers","*"),r.send()}function selectArea(e){const t=["area1","area2"];document.getElementById(t[currentAreaIdx]).className="areaButton",document.getElementById(t[e]).className="areaButtonSelected",currentAreaIdx=e;let a=areaimages[e];canvas.height=canvas.width*a.height/a.width,selectParam(currentParamName)}function selectParam(e){document.getElementById(currentParamName).className="paramButton",document.getElementById(e).className="paramButtonSelected",currentParamName=e,plotReports(e)}function plotReports(e){for(report of(g.drawImage(areaimages[currentAreaIdx],0,0,canvas.width,canvas.height),hotRects=[],reports)){let{x:t,y:a}=getxy(report);g.translate(t,a);let r=plotReport(report,e);r&&(r.left+=t,r.right+=t,r.top+=a,r.bottom+=a,hotRects.push({...r,station:report.station})),g.translate(-t,-a)}let t=dataDate.getHours(),a=dataDate.getMinutes(),r=(t>9?"":"0")+t+":"+(a>9?"":"0")+a;g.fillStyle="white",g.fillRect(0,0,42,16),g.font="14px arial",g.fillStyle="black",g.fillText(r,3,12)}function getxy(e){let t=areaCoords[currentAreaIdx];return{x:(e.station.longitude-t.left)/(t.right-t.left)*canvas.width,y:(t.top-e.station.latitude)/(t.top-t.bottom)*canvas.height}}function plotReport(e,t){let a=e.observation[t];if(!a)return;let r=a.value;if(!r)return;let o,{textColor:n,backgroundColor:i,decimal:s}=paramSyle(t,r);if("icing"===t)switch(o="",r){case 0:r="Aucun";break;case 1:r="Faible";break;case 2:r="Elevé"}else o=a.unit;let l=Math.floor(r);s||(r=l);const c="15px arial",d=getTextWidth(""+r,c)+2+getTextWidth(o,"12px arial");g.fillStyle=i,g.beginPath(),g.roundRect?(g.roundRect(-27,-25,54,20,5),g.fill()):g.fillRect(-27,-22,54,20),g.fillStyle=n,g.font=c;let u=(54-d)/2-27,m=-10;g.fillText(l,u,m),u+=getTextWidth(l,c),g.font="12px arial",s&&(g.fillText("."+Math.round(10*(r-l)),u,m),u+=getTextWidth(".9","12px arial")),u+=2,g.fillText(a.unit,u,m),g.fillStyle="dimgray",m=10;for(let t of stationShortName(e.station).split("\n"))g.fillText(t,-getTextWidth(t,"12px arial")/2,m),m+=13;return{left:-27,top:-22,right:27,bottom:-2}}function paramSyle(e,t){let a,r="white",o=!1;switch(e){case"temperature":a=temperatureColor(t),o=!0;break;case"humidity":a="royalblue";break;case"wind_s":a="salmon";break;case"icing":switch(r="black",t){case 0:a="green";case 1:a="yellow";case 2:a="red"}}return{textColor:r,backgroundColor:a}}function temperatureColor(e){const t=[-15,-10,0,10,15,25],a=[0,0,140,20,150,255],r=[140,0,140,210,170,70],o=[170,230,255,40,0,70];let n=0,i=0,s=0;for(let l=0;l<t.length;l++){if(e<=t[l]){if(0===l)n=a[0],i=r[0],s=o[0];else{const c=(e-t[l-1])/(t[l]-t[l-1]);n=a[l-1]+c*(a[l]-a[l-1]),i=r[l-1]+c*(r[l]-r[l-1]),s=o[l-1]+c*(o[l]-o[l-1])}break}l===t.length-1&&(n=a[3],i=r[3],s=o[3])}return"rgb("+Math.round(n)+","+Math.round(i)+","+Math.round(s)+")"}function showDetails(e){let t=e.pageX-(canvas.offsetLeft+canvas.clientLeft),a=e.pageY-(canvas.offsetTop+canvas.clientTop);for(const e of hotRects)if(t>=e.left&&t<=e.right&&a>=e.top&&a<=e.bottom){document.getElementById("modal-1").click(),document.getElementById("station").innerHTML=stationShortName(e.station).replace("\n"," - "),e.station.elevation&&(document.getElementById("elevation").innerHTML=e.station.elevation);let t=document.getElementById("history"),a=(new Date).getTime();a-=a%108e5;for(let r=2;r>=0;r--){t.rows[1].cells[r].innerHTML=new Date(a).getDate();for(let o=a/108e5%8;o>=0;o--,a-=108e5)download(new Date(a),function(){if(4===this.readyState&&200===this.status)for(report of JSON.parse(this.responseText))if(report.station.uuid===e.station.uuid){const e=report.observation;let a="";e.temperature&&(a=e.temperature.value+"°C  "),e.humidity&&(a+=e.humidity.value+"%"),t.rows[o+2].cells[r+1].innerHTML=a}})}let r=document.getElementById("more");"babe0746-591f-4514-913c-e0943d45f62f"===e.station.uuid?(r.href="https://www.infoclimat.fr/observations-meteo/temps-reel/bourg-st-maurice/07497.html",r.hidden=!1):r.hidden=!0}}function stationShortName(e){switch(e.uuid){case"babe0746-591f-4514-913c-e0943d45f62f":return"Bourg St Maurice";case"922d3013-f25a-4984-99af-bea696ae0a38":return"Aiguille Rouge";case"90fa62d7-40d5-447c-b7b5-dc5f7a52b6f3":return"La Rosière\nLe Fort";case"98ed1815-da1a-415b-a559-4c451386a437":return"La Rosière\nFront de neige";case"47604055-03ae-4d09-93eb-d4a8cf7a4316":return"Les Arcs 1600\nSanglier qui fume";default:return e.name}}function getTextWidth(e,t){const a=(getTextWidth.canvas||(getTextWidth.canvas=document.createElement("canvas"))).getContext("2d");return a.font=t,a.measureText(e).width}canvas.width>window.width&&(canvas.width=window.width),area1image.addEventListener("load",()=>selectArea(0)),downloadReports();
